services:
  # FastAPI Backend (Web Service)
  - type: web
    name: ai-scheduler-api
    env: python
    region: oregon
    plan: starter
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && uvicorn main:app --host 0.0.0.0 --port $PORT
    envVars:
      - key: PYTHON_VERSION
        value: 3.13.0
      - key: DATABASE_URL
        fromDatabase:
          name: ai-scheduler-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-scheduler-redis
          property: connectionString
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: GOOGLE_CALENDAR_CREDENTIALS_FILE
        value: credentials.json
      - key: GOOGLE_CALENDAR_TOKEN_FILE
        value: token.json
      - key: GOOGLE_CALENDAR_ID
        sync: false
      - key: API_BASE_URL
        value: https://ai-scheduler-api.onrender.com
      - key: FRONTEND_URL
        value: https://ai-scheduler-frontend.onrender.com
      - key: SECRET_KEY
        generateValue: true
      - key: SENTRY_DSN
        sync: false
      - key: MAX_CONCURRENT_CALLS
        value: 50
      - key: CALL_TIMEOUT_SECONDS
        value: 300
      - key: MAX_CONVERSATION_TURNS
        value: 20
    healthCheckPath: /health
    autoDeploy: true

  # Celery Worker (Background Worker)
  - type: worker
    name: ai-scheduler-worker
    env: python
    region: oregon
    plan: starter
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && celery -A workers.celery_app worker --loglevel=info
    envVars:
      - key: PYTHON_VERSION
        value: 3.13.0
      - key: DATABASE_URL
        fromDatabase:
          name: ai-scheduler-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: ai-scheduler-redis
          property: connectionString
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_PHONE_NUMBER
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ELEVENLABS_API_KEY
        sync: false
      - key: DEEPGRAM_API_KEY
        sync: false
      - key: GOOGLE_CALENDAR_CREDENTIALS_FILE
        value: credentials.json
      - key: GOOGLE_CALENDAR_TOKEN_FILE
        value: token.json
      - key: GOOGLE_CALENDAR_ID
        sync: false
      - key: API_BASE_URL
        value: https://ai-scheduler-api.onrender.com
      - key: SECRET_KEY
        sync: false
    autoDeploy: true
    scaling:
      minInstances: 1
      maxInstances: 10
      targetCPUPercent: 70

  # React Frontend (Static Site)
  - type: web
    name: ai-scheduler-frontend
    env: static
    region: oregon
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: frontend/dist
    envVars:
      - key: VITE_API_URL
        value: https://ai-scheduler-api.onrender.com
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    autoDeploy: true

databases:
  # PostgreSQL Database
  - name: ai-scheduler-db
    databaseName: ai_scheduler
    user: ai_scheduler_user
    plan: starter
    region: oregon
    ipAllowList: []

# Redis (for Celery task queue)
# Note: Render doesn't support Redis in render.yaml, so you'll need to add it manually
# via the Render dashboard or use an external service like Upstash
